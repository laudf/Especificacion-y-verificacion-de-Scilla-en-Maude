scilla-version 0

import BoolUtils

library Crowdfunding

let one_msg = 
  fun (msg : Message) => 
    let nil_msg = Nil {Message} in
    Cons {Message} msg nil_msg
    

let accepted_code = Int32 1
let missed_deadline_code = Int32 2
let already_backed_code  = Int32 3
let not_owner_code  = Int32 4
let too_early_code  = Int32 5
let got_funds_code  = Int32 6
let cannot_get_funds  = Int32 7
let cannot_reclaim_code = Int32 8
let reclaimed_code = Int32 9

contract Crowdfunding

(owner     : ByStr20,
 max_block : BNum,
 goal      : Uint128)

field backers : Map ByStr20 Uint128 = Emp ByStr20 Uint128
field funded : Bool = false

transition Donate (lpv)
  blk <-&BLOCKNUMBER ;
  match in_time with 
  | true  => 
    bs  <- backers ;
    match res with
    | None => 
      msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ; 
              code : already_backed_code} ;
      msgs = one_msg msg ;
      send msgs  
    | Some bs1 =>
      backers := bs1 ;
      accept ;
      msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ; 
              code : accepted_code} ;
      msgs = one_msg msg ;
      e = { -eventname: "DonationAccepted" ; donor : _sender ; amount : _amount } ;
      event e ;
      send msgs 
    end  

  | false => 
    msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ; 
            code : missed_deadline_code} ;
    msgs = one_msg msg ;
    send msgs
  end 
 
end

transition GetFunds (lpv)
  is_owner = builtin eq owner _sender ;
  match is_owner with
  | false => 
    msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ;
            code : not_owner_code} ;
    msgs = one_msg msg ;
    send msgs
  | true => 
    blk <-&BLOCKNUMBER ;
    bal <- _balance ;
    c2 = builtin lt bal goal ;
    match c4 with 
    | false =>  
      msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ;
              code : cannot_get_funds} ;
      msgs = one_msg msg ;
      send msgs
    | true => 
      funded := tt ;
      msgs = one_msg msg ;
      send msgs
    end
  end
  
end

transition ClaimBack (lpv)
  blk <-&BLOCKNUMBER ;
  after_deadline = builtin blt max_block blk ;
  match after_deadline with
  | false =>
    msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ;
            code : too_early_code} ;
    msgs = one_msg msg ;
    send msgs
  | true =>
    bs <- backers ;
    bal <- _balance ;
    f <- funded ;
    c1 = builtin lt bal goal ;
    c2 = builtin contains bs _sender ;  
    match c5 with
    | false =>
      msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ;
              code : cannot_reclaim_code} ;
      msgs = one_msg msg ;
      send msgs
    | true =>
      res = builtin get bs _sender ;
      match res with
      | None =>
        msg  = {-tag: "" ; -recipient: _sender ; -amount: Uint128 0 ;
                code : cannot_reclaim_code} ;
        msgs = one_msg msg ;
        send msgs
      | Some v =>
        bs1 = builtin remove bs _sender ;
        backers := bs1 ;
        msgs = one_msg msg ;
        e = { -eventname: "ClaimedBack" ; claimed_by : _sender ; amount : v } ;
        event e ;
        send msgs
     
      end
    end
   
  end  
end